{
  "permissions": {
    "allow": [
      "Bash(deno run:*)",
      "Bash(npx tsx:*)",
      "Bash(git merge:*)",
      "Bash(npx tsc:*)",
      "Bash(npm run build:*)",
      "Bash(npx supabase:*)",
      "Bash(node fix_rpc_now.js:*)",
      "Bash(cat:*)",
      "Bash(where:*)",
      "Bash(node execute_sql_fix.mjs:*)",
      "Bash(git add:*)",
      "Bash(git commit -m \"$(cat <<''EOF''\nfeat: add complete Google Calendar integration\n\n## Features\n- OAuth 2.0 authentication with Google\n- Bidirectional sync (from_google, to_google, both)\n- Automatic sync via cron job (every 1 minute)\n- Webhook support for real-time updates\n- Conflict detection with \"Google wins\" policy\n- Pagination for large calendars (up to 2500 events)\n- Bidirectional deletion (local â†’ Google)\n\n## Security Improvements\n- Dynamic CORS (hub.pescalead.com.br, localhost)\n- Owner validation on /refresh endpoint\n- Centralized token management (_shared/google-auth.ts)\n- etag comparison to skip unchanged events\n\n## Edge Functions\n- google-oauth: OAuth flow, disconnect, refresh, status\n- google-calendar: list, select, sync, webhooks\n- google-webhook: receive Google notifications\n- google-calendar-sync-cron: scheduled sync with retry\n\n## Database\n- google_calendar_connections: OAuth tokens\n- google_calendar_sync: calendar sync config\n- google_sync_log: sync history\n- google_sync_queue: processing queue\n- Optimized indices for cron queries\n\nðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>\nEOF\n)\")",
      "Bash(git push:*)",
      "Bash(git checkout:*)",
      "Bash(dir /b \"c:\\Users\\Asus\\Pictures\\Pesca lead - Back-end\\supabase\\migrations\\*.sql\")",
      "Bash(findstr:*)",
      "Bash(git stash:*)",
      "Bash(git pull:*)",
      "Bash(git commit -m \"$\\(cat <<''EOF''\nfix: add WhatsApp extraction from external URLs in Instagram enrichment\n\n## CorreÃ§Ã£o CrÃ­tica\n- WhatsApp links em `externalUrls` agora sÃ£o extraÃ­dos corretamente\n- PadrÃµes suportados: wa.me/NUMBER e api.whatsapp.com/send?phone=NUMBER\n- Remove prefixo +55 automaticamente\n\n## Melhorias de UX\n- NavegaÃ§Ã£o baseada em URL \\(sem hash\\)\n- Links pÃºblicos de chat limpos\n- Auto-geraÃ§Ã£o de nomes de extraÃ§Ã£o CNPJ\n- SeparaÃ§Ã£o de cards min/max seguidores\n\n## CorreÃ§Ãµes de Bugs\n- ExibiÃ§Ã£o correta de `created_quantity` em histÃ³rico CNPJ\n- Filtros CNPJ com loading state melhorado\n- Lead modal fecha e limpa URL corretamente\n\nðŸ¤– Generated with [Claude Code]\\(https://claude.com/claude-code\\)\n\nCo-Authored-By: Claude Sonnet 4.5 \\(1M context\\) <noreply@anthropic.com>\nEOF\n\\)\")",
      "Bash(git commit -m \"$\\(cat <<''EOF''\nfeat: add Instagram website scraping integration\n\n## Nova Funcionalidade\n- Sistema completo de scraping de websites do Instagram\n- ValidaÃ§Ã£o rigorosa de URLs \\(70+ domÃ­nios bloqueados\\)\n- ExtraÃ§Ã£o de WhatsApp de links wa.me antes de skip\n- Retry com backoff exponencial \\(1min, 2min, 4min\\)\n- DeduplicaÃ§Ã£o preservando origem \\(Instagram + Website\\)\n\n## Infraestrutura\n- 9 novas colunas em instagram_enriched_profiles\n- FunÃ§Ãµes SQL: process_instagram_scraping_result, get_pending_websites_locked, increment_run_counters\n- Edge functions: instagram-website-enqueue \\(cron\\), process-scraping-queue V7\n- MÃ³dulos compartilhados: website-validator.ts, contact-deduplication.ts\n\n## ValidaÃ§Ãµes e SeguranÃ§a\n- JSONB injection protection \\(sanitizaÃ§Ã£o rigorosa\\)\n- CNPJ validation com checksum\n- WhatsApp validation \\(10-15 dÃ­gitos, formato brasileiro\\)\n- URL normalization \\(adiciona https:// automaticamente\\)\n- Captcha detection \\(403 â†’ blocked, nÃ£o retry\\)\n\n## Performance\n- Lock pessimista \\(FOR UPDATE SKIP LOCKED\\) previne race conditions\n- VT_SECONDS aumentado para 240s \\(previne reprocessamento\\)\n- Incremento atÃ´mico de counters \\(previne lost updates\\)\n- Ãndices compostos otimizados\n\n## Bloqueadores Resolvidos\n- B1: TransaÃ§Ã£o ausente \\(funÃ§Ã£o SQL transacional\\)\n- B2: PGMQ sem delay \\(next_retry_at + DLQ\\)\n- B3: JSONB injection \\(sanitizaÃ§Ã£o\\)\n- B4-B10: ValidaÃ§Ãµes, timeouts, Ã­ndices\n\nðŸ¤– Generated with [Claude Code]\\(https://claude.com/claude-code\\)\n\nCo-Authored-By: Claude Sonnet 4.5 \\(1M context\\) <noreply@anthropic.com>\nEOF\n\\)\")",
      "Bash(npm audit:*)",
      "Bash(semgrep scan:*)",
      "Bash(node scripts/validate-security-fixes.mjs:*)",
      "Bash(supabase/functions/_shared/cors.ts )",
      "Bash(supabase/functions/_shared/rate-limiter.ts )",
      "Bash(supabase/functions/admin-change-password/index.ts )",
      "Bash(supabase/functions/admin-create-user/index.ts )",
      "Bash(supabase/functions/admin-create-user-with-workspace/index.ts )",
      "Bash(supabase/functions/admin-create-workspace-batch/index.ts )",
      "Bash(supabase/functions/admin-delete-user/index.ts )",
      "Bash(supabase/functions/exec-sql/index.ts )",
      "Bash(supabase/functions/ai-webhook-receiver/index.ts )",
      "Bash(supabase/functions/google-webhook/index.ts )",
      "Bash(supabase/functions/ai-public-chat/index.ts )",
      "Bash(supabase/functions/public-booking/index.ts )",
      "Bash(supabase/functions/widget-chat/index.ts )",
      "Bash(supabase/functions/send-notification/index.ts )",
      "Bash(supabase/functions/fetch-google-maps/index.ts )",
      "Bash(supabase/functions/make-server-34fac51f/index.tsx )",
      "Bash(supabase/functions/make-server-34fac51f/supabase-client.ts )",
      "Bash(supabase/functions/make-server-34fac51f/provider-evolution.ts )",
      "Bash(supabase/functions/make-server-34fac51f/provider-uazapi.ts )",
      "Bash(supabase/functions/make-server-e4f9d774/index.tsx )",
      "Bash(supabase/functions/make-server-e4f9d774/supabase-client.ts )",
      "Bash(supabase/functions/make-server-e4f9d774/provider-evolution.ts )",
      "Bash(supabase/functions/make-server-e4f9d774/provider-uazapi.ts )",
      "Bash(supabase/migrations/20251230230000_fix_instagram_rls.sql )",
      "Bash(supabase/migrations/20251230230001_fix_instagram_functions_security.sql )",
      "Bash(supabase/migrations/20251230230002_fix_login_attempts_rls.sql )",
      "Bash(scripts/validate-security-fixes.mjs)",
      "Bash(git commit -m \"$\\(cat <<''EOF''\nsecurity: comprehensive security hardening for Edge Functions\n\n## Security Fixes\n\n### CORS Restrictions\n- Created `_shared/cors.ts` module with domain whitelist\n- Admin functions now restrict CORS to hub.pescalead.com.br and localhost\n- Affected: admin-create-user, admin-delete-user, admin-change-password,\n  admin-create-user-with-workspace, admin-create-workspace-batch, exec-sql\n\n### Authentication & Authorization\n- exec-sql now requires super_admin authentication \\(was open!\\)\n- Added JWT validation before SQL execution\n- Returns 401/403 for unauthorized access attempts\n\n### Rate Limiting\n- Created `_shared/rate-limiter.ts` module \\(sliding window algorithm\\)\n- Added rate limiting to public endpoints: public-booking, ai-public-chat, widget-chat\n\n### Webhook Security\n- google-webhook validates GOOGLE_WEBHOOK_SECRET \\(optional\\)\n- ai-webhook-receiver validates AI_WEBHOOK_SECRET \\(optional\\)\n\n### Log Sanitization\n- Removed token/key exposure from logs \\(now shows [REDACTED]\\)\n- Affected: make-server-*, fetch-google-maps, supabase-client.ts, provider-*.ts\n\n### Sensitive Data Protection\n- send-notification reads SMTP password from SMTP_PASSWORD env var\n- Removed PII from error responses \\(no more stack traces\\)\n\n## Database Migrations\n\n### Instagram RLS \\(20251230230000\\)\n- Enabled RLS on instagram_discovery_results and instagram_enriched_profiles\n- Added workspace-based policies \\(SELECT, INSERT, UPDATE for members\\)\n- Added DELETE policies restricted to admins/owners\n- Added service_role bypass for Edge Functions\n\n### Instagram Functions Security \\(20251230230001\\)\n- Added SECURITY DEFINER to get_pending_instagram_websites_locked\n- Added SECURITY DEFINER to get_instagram_scraping_stats\n- Added SECURITY DEFINER to increment_run_counters\n- Set search_path = public for all\n\n### Login Attempts RLS \\(20251230230002\\)\n- Added service_role policy for login_attempts table\n\n## Testing\n- Added scripts/validate-security-fixes.mjs for automated security testing\n- All 11 security tests passing\n\nðŸ¤– Generated with [Claude Code]\\(https://claude.com/claude-code\\)\n\nCo-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>\nEOF\n\\)\")",
      "Bash(curl:*)",
      "Bash(node:*)"
    ]
  }
}
